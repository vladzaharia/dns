name: DNSControl Push

on:
  push:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write
  checks: write

jobs:
  # Parallel validation jobs
  build:
    name: Build
    uses: ./.github/workflows/_reusable-build.yml

  lint:
    name: Lint
    uses: ./.github/workflows/_reusable-lint.yml

  format:
    name: Format
    uses: ./.github/workflows/_reusable-format.yml

  typecheck:
    name: Typecheck
    uses: ./.github/workflows/_reusable-typecheck.yml

  test:
    name: Test
    uses: ./.github/workflows/_reusable-test.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write

  # Push runs after all validation jobs pass
  push:
    name: Push
    needs: [build, lint, format, typecheck, test]
    uses: ./.github/workflows/_reusable-push.yml
    secrets:
      CF_API: ${{ secrets.CF_API }}
