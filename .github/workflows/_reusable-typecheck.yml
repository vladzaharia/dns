name: Typecheck

on:
  workflow_call:
    outputs:
      result:
        description: "Typecheck result (success/failure)"
        value: ${{ jobs.typecheck.outputs.result }}
      packages:
        description: "Per-package typecheck results JSON"
        value: ${{ jobs.typecheck.outputs.packages }}

jobs:
  typecheck:
    name: TypeScript
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.typecheck.outcome }}
      packages: ${{ steps.typecheck.outputs.packages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm run build

      - name: Run typecheck
        id: typecheck
        shell: bash
        continue-on-error: true
        run: |
          PACKAGES_JSON="["
          FIRST_PKG=true
          OVERALL_EXIT=0

          # Get all packages
          PACKAGES=$(pnpm ls -r --json 2>/dev/null | jq -r '.[] | select(.name != null and .name != "polaris-dns-monorepo") | .name')

          for pkg in $PACKAGES; do
            echo "::group::Typechecking $pkg"
            set +e
            pnpm --filter "$pkg" run typecheck 2>&1
            PKG_EXIT=$?
            set -e

            if [ $PKG_EXIT -eq 0 ]; then
              STATUS="success"
              echo "✅ $pkg typecheck passed"
            else
              STATUS="failure"
              OVERALL_EXIT=1
              echo "❌ $pkg typecheck failed"
            fi

            if [ "$FIRST_PKG" = true ]; then
              FIRST_PKG=false
            else
              PACKAGES_JSON+=","
            fi
            PACKAGES_JSON+="{\"name\":\"$pkg\",\"status\":\"$STATUS\"}"
            echo "::endgroup::"
          done

          PACKAGES_JSON+="]"
          echo "packages=$PACKAGES_JSON" >> $GITHUB_OUTPUT
          exit $OVERALL_EXIT

      - name: Check for failures
        if: steps.typecheck.outcome == 'failure'
        run: |
          echo "::error::Typecheck failed"
          exit 1

