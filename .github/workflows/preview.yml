name: DNSControl Preview

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write
  checks: write

jobs:
  # Parallel validation jobs
  build:
    name: Build
    uses: ./.github/workflows/_reusable-build.yml

  lint:
    name: Lint
    uses: ./.github/workflows/_reusable-lint.yml

  format:
    name: Format
    uses: ./.github/workflows/_reusable-format.yml

  typecheck:
    name: Typecheck
    uses: ./.github/workflows/_reusable-typecheck.yml

  test:
    name: Test
    uses: ./.github/workflows/_reusable-test.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write

  # Preview runs after all validation jobs pass
  preview:
    name: Preview
    needs: [build, lint, format, typecheck, test]
    uses: ./.github/workflows/_reusable-preview.yml
    secrets:
      CF_API: ${{ secrets.CF_API }}

  # Comment runs after preview
  comment:
    name: Comment
    needs: [build, lint, format, typecheck, test, preview]
    # Skip comment job when running locally with act (uses event.json with "act": true)
    if: always() && github.event_name == 'pull_request' && !github.event.act
    uses: ./.github/workflows/_reusable-comment.yml
    with:
      build-result: ${{ needs.build.outputs.result }}
      build-packages: ${{ needs.build.outputs.packages }}
      lint-result: ${{ needs.lint.outputs.result }}
      lint-packages: ${{ needs.lint.outputs.packages }}
      format-result: ${{ needs.format.outputs.result }}
      format-packages: ${{ needs.format.outputs.packages }}
      typecheck-result: ${{ needs.typecheck.outputs.result }}
      typecheck-packages: ${{ needs.typecheck.outputs.packages }}
      test-result: ${{ needs.test.outputs.result }}
      test-packages: ${{ needs.test.outputs.packages }}
      coverage-total: ${{ needs.test.outputs.coverage-total }}
      coverage-json: ${{ needs.test.outputs.coverage-json }}
      preview-result: ${{ needs.preview.result }}
      has-changes: ${{ needs.preview.outputs.has-changes }}
      changes-summary: ${{ needs.preview.outputs.changes-summary }}
      domain-summary: ${{ needs.preview.outputs.domain-summary }}
      changes-data: ${{ needs.preview.outputs.changes-data }}
      base-domains: ${{ needs.preview.outputs.base-domains }}
