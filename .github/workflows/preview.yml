name: DNSControl Preview

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  validate:
    name: Validate
    uses: ./.github/workflows/_reusable-validate.yml

  prepare:
    name: Build
    needs: validate
    uses: ./.github/workflows/_reusable-prepare.yml

  preview:
    name: Preview
    needs: [validate, prepare]
    uses: ./.github/workflows/_reusable-preview.yml
    secrets:
      CF_API: ${{ secrets.CF_API }}

  comment:
    name: Comment
    needs: [validate, prepare, preview]
    # Skip comment job when running locally with act (uses event.json with "act": true)
    if: always() && github.event_name == 'pull_request' && !github.event.act
    uses: ./.github/workflows/_reusable-comment.yml
    with:
      validate-result: ${{ needs.validate.outputs.validate-result }}
      validate-packages: ${{ needs.validate.outputs.validate-packages }}
      test-result: ${{ needs.validate.outputs.test-result }}
      test-packages: ${{ needs.validate.outputs.test-packages }}
      prepare-result: ${{ needs.prepare.result }}
      build-packages: ${{ needs.prepare.outputs.build-packages }}
      preview-result: ${{ needs.preview.result }}
      has-changes: ${{ needs.preview.outputs.has-changes }}
      changes-summary: ${{ needs.preview.outputs.changes-summary }}
      domain-summary: ${{ needs.preview.outputs.domain-summary }}
      changes-data: ${{ needs.preview.outputs.changes-data }}
      base-domains: ${{ needs.preview.outputs.base-domains }}
