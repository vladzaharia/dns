name: Validate Code

on:
  workflow_call:
    outputs:
      validate-result:
        description: "Overall validation result (success/failure)"
        value: ${{ jobs.validate.outputs.validate-result }}
      validate-output:
        description: "Full validation output"
        value: ${{ jobs.validate.outputs.validate-output }}
      validate-packages:
        description: "Per-package validation results JSON"
        value: ${{ jobs.validate.outputs.validate-packages }}
      test-result:
        description: "Test result (success/failure)"
        value: ${{ jobs.validate.outputs.test-result }}
      test-output:
        description: "Test output"
        value: ${{ jobs.validate.outputs.test-output }}
      test-packages:
        description: "Per-package test results JSON"
        value: ${{ jobs.validate.outputs.test-packages }}

jobs:
  validate:
    name: Lint, Format, Typecheck, and Test
    runs-on: ubuntu-latest
    outputs:
      validate-result: ${{ steps.validate.outcome }}
      validate-output: ${{ steps.validate.outputs.output }}
      validate-packages: ${{ steps.validate.outputs.packages }}
      test-result: ${{ steps.test.outcome }}
      test-output: ${{ steps.test.outputs.output }}
      test-packages: ${{ steps.test-summary.outputs.packages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm run build

      - name: Run validation per package
        id: validate
        shell: bash
        continue-on-error: true
        run: |
          FULL_OUTPUT=""
          OVERALL_EXIT=0
          PACKAGES_JSON="["
          FIRST_PKG=true

          # Get all packages
          PACKAGES=$(pnpm ls -r --json 2>/dev/null | jq -r '.[] | select(.name != null and .name != "polaris-dns-monorepo") | .name')

          for pkg in $PACKAGES; do
            echo "::group::Validating $pkg"

            LINT_STATUS="success"
            FORMAT_STATUS="success"
            TYPECHECK_STATUS="success"
            PKG_OUTPUT="=== $pkg ===\n"

            # Run lint
            set +e
            LINT_OUT=$(pnpm --filter "$pkg" run lint 2>&1)
            if [ $? -ne 0 ]; then
              LINT_STATUS="failure"
              OVERALL_EXIT=1
            fi
            PKG_OUTPUT+="--- Lint ---\n$LINT_OUT\n"
            set -e

            # Run format check
            set +e
            FORMAT_OUT=$(pnpm --filter "$pkg" run format:check 2>&1)
            if [ $? -ne 0 ]; then
              FORMAT_STATUS="failure"
              OVERALL_EXIT=1
            fi
            PKG_OUTPUT+="--- Format ---\n$FORMAT_OUT\n"
            set -e

            # Run typecheck
            set +e
            TYPECHECK_OUT=$(pnpm --filter "$pkg" run typecheck 2>&1)
            if [ $? -ne 0 ]; then
              TYPECHECK_STATUS="failure"
              OVERALL_EXIT=1
            fi
            PKG_OUTPUT+="--- Typecheck ---\n$TYPECHECK_OUT\n"
            set -e

            FULL_OUTPUT+="$PKG_OUTPUT\n"

            # Add to per-package JSON
            if [ "$FIRST_PKG" = true ]; then
              FIRST_PKG=false
            else
              PACKAGES_JSON+=","
            fi
            PACKAGES_JSON+="{\"name\":\"$pkg\",\"lint\":\"$LINT_STATUS\",\"format\":\"$FORMAT_STATUS\",\"typecheck\":\"$TYPECHECK_STATUS\"}"

            echo "::endgroup::"
          done

          PACKAGES_JSON+="]"

          echo "packages=$PACKAGES_JSON" >> $GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FULL_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $OVERALL_EXIT

      - name: Run tests per package
        id: test
        shell: bash
        continue-on-error: true
        run: |
          FULL_OUTPUT=""
          OVERALL_EXIT=0

          # Get packages
          PACKAGES=$(pnpm ls -r --json 2>/dev/null | jq -r '.[] | select(.name != null and .name != "polaris-dns-monorepo") | .name')

          for pkg in $PACKAGES; do
            echo "::group::Testing $pkg"
            set +e
            # Run test with JSON output
            PKG_OUTPUT=$(pnpm --filter "$pkg" run test -- --reporter=verbose --reporter=json --outputFile=test-results.json 2>&1)
            PKG_EXIT=$?
            if [ $PKG_EXIT -ne 0 ]; then
              OVERALL_EXIT=1
            fi
            FULL_OUTPUT="${FULL_OUTPUT}
          === $pkg ===
          $PKG_OUTPUT
          "
            set -e
            echo "::endgroup::"
          done

          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $OVERALL_EXIT

      - name: Parse test results
        id: test-summary
        if: always()
        shell: bash
        run: |
          # Initialize per-package JSON
          PACKAGES_JSON="["
          FIRST_PKG=true

          # Find and parse all test-results.json files
          for file in $(find ./packages -name "test-results.json" -type f 2>/dev/null); do
            if [ -f "$file" ] && jq -e . "$file" > /dev/null 2>&1; then
              # Extract package name from path
              PKG_PATH=$(dirname "$file")
              PKG_NAME=$(jq -r '.name // "unknown"' "$PKG_PATH/package.json" 2>/dev/null || basename "$PKG_PATH")

              # Parse Vitest JSON output
              FILE_TOTAL=$(jq '[.testResults[].assertionResults | length] | add // 0' "$file" 2>/dev/null || echo 0)
              FILE_PASSED=$(jq '[.testResults[].assertionResults[] | select(.status == "passed")] | length // 0' "$file" 2>/dev/null || echo 0)
              FILE_FAILED=$(jq '[.testResults[].assertionResults[] | select(.status == "failed")] | length // 0' "$file" 2>/dev/null || echo 0)
              FILE_SKIPPED=$(jq '[.testResults[].assertionResults[] | select(.status == "skipped" or .status == "pending" or .status == "todo")] | length // 0' "$file" 2>/dev/null || echo 0)

              # Determine status
              if [ "$FILE_FAILED" -gt 0 ]; then
                STATUS="failure"
              else
                STATUS="success"
              fi

              # Add to per-package JSON
              if [ "$FIRST_PKG" = true ]; then
                FIRST_PKG=false
              else
                PACKAGES_JSON+=","
              fi
              PACKAGES_JSON+="{\"name\":\"$PKG_NAME\",\"total\":$FILE_TOTAL,\"passed\":$FILE_PASSED,\"failed\":$FILE_FAILED,\"skipped\":$FILE_SKIPPED,\"status\":\"$STATUS\"}"
            fi
          done

          PACKAGES_JSON+="]"
          echo "packages=$PACKAGES_JSON" >> $GITHUB_OUTPUT

      - name: Check for failures
        if: steps.validate.outcome == 'failure' || steps.test.outcome == 'failure'
        run: |
          echo "::error::One or more validation checks failed"
          echo "Validate: ${{ steps.validate.outcome }}"
          echo "Test: ${{ steps.test.outcome }}"
          exit 1

