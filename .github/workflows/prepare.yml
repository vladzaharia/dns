name: Build and Prepare for Preview/Push

on:
  workflow_call:
    outputs:
      build-result:
        description: "Build result (success/failure)"
        value: ${{ jobs.compile.outputs.build-result }}
      build-output:
        description: "Build output"
        value: ${{ jobs.compile.outputs.build-output }}
      build-packages:
        description: "Per-package build results JSON"
        value: ${{ jobs.compile.outputs.build-packages }}

jobs:
  compile:
    name: Compile TypeScript and Download Binaries
    runs-on: ubuntu-latest
    outputs:
      build-result: ${{ steps.build.outcome }}
      build-output: ${{ steps.build.outputs.output }}
      build-packages: ${{ steps.build.outputs.packages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build JS files
        id: build
        shell: bash
        run: |
          # Build each package and track results
          declare -A RESULTS
          FULL_OUTPUT=""
          OVERALL_EXIT=0

          # Get list of packages with build scripts
          PACKAGES=$(pnpm ls -r --json 2>/dev/null | jq -r '.[] | select(.name != null and .name != "polaris-dns-monorepo") | .name')

          for pkg in $PACKAGES; do
            echo "::group::Building $pkg"
            set +e
            PKG_OUTPUT=$(pnpm --filter "$pkg" run build 2>&1)
            PKG_EXIT=$?
            set -e

            if [ $PKG_EXIT -eq 0 ]; then
              RESULTS["$pkg"]="success"
              echo "✅ $pkg build succeeded"
            else
              RESULTS["$pkg"]="failure"
              OVERALL_EXIT=1
              echo "❌ $pkg build failed"
            fi

            FULL_OUTPUT="${FULL_OUTPUT}
          === $pkg ===
          $PKG_OUTPUT
          "
            echo "::endgroup::"
          done

          # Create JSON output for packages
          PACKAGES_JSON="{"
          FIRST=true
          for pkg in "${!RESULTS[@]}"; do
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              PACKAGES_JSON+=","
            fi
            PACKAGES_JSON+="\"$pkg\":\"${RESULTS[$pkg]}\""
          done
          PACKAGES_JSON+="}"

          echo "packages=$PACKAGES_JSON" >> $GITHUB_OUTPUT

          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $OVERALL_EXIT

      - name: Upload compiled JS
        uses: actions/upload-artifact@v4
        with:
          name: out
          path: packages/polaris-dns/out/*
          retention-days: 1

      - name: Upload DNSControl binaries
        uses: actions/upload-artifact@v4
        with:
          name: bin
          path: packages/dnscontrol-download/bin/dnscontrol-*
          retention-days: 1
