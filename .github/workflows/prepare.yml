name: Build and Prepare for Preview/Push

on:
  workflow_call:
    secrets:
      VAULT_ROLE_ID:
        required: true
      VAULT_SECRET_ID:
        required: true

    # Map the workflow outputs to job outputs
    outputs:
      CF_API:
        description: "Cloudflare API key"
        value: ${{ jobs.token.outputs.CF_API }}

jobs:
  build:
    name: Compile TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js v14
        uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: npm
      - name: Download dependencies
        run: npm ci
      - name: Build JS files
        run: npm run build
      - name: Upload compiled JS
        uses: actions/upload-artifact@v3
        with:
          name: out
          path: out/*
  token:
    name: Retrieve Cloudflare token
    runs-on: ubuntu-latest
    outputs:
      CF_API: ${{ steps.secrets.outputs.CF_API }}
    steps:
      - name: Retrieve token from Vault
        id: secrets
        uses: hashicorp/vault-action@v2.4.0
        with:
          url: https://vault.zhr.one
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            projects/data/dnscontrol CF_API | CF_API
  lib:
    name: Download DNSControl binaries
    runs-on: ubuntu-latest
    steps:
      - name: Download latest binaries
        run: |
          mkdir lib
          cd lib
          LATEST_RELEASE=$(curl -L -s -H 'Accept: application/json' https://github.com/StackExchange/dnscontrol/releases/latest)
          LATEST_VERSION=$(echo $LATEST_RELEASE | sed -e 's/.*"tag_name":"\([^"]*\)".*/\1/')
          ARTIFACT_BASE_URL="https://github.com/StackExchange/dnscontrol/releases/download/$LATEST_VERSION"
          curl -o dnscontrol-Darwin $ARTIFACT_BASE_URL/dnscontrol-Darwin
          curl -o dnscontrol-Linux $ARTIFACT_BASE_URL/dnscontrol-Linux
          curl -o dnscontrol.exe $ARTIFACT_BASE_URL/dnscontrol.exe
          echo $LATEST_VERSION > ./VERSION
        shell: bash
      - name: Upload DNSControl binaries
        uses: actions/upload-artifact@v3
        with:
          name: lib
          path: lib/*
