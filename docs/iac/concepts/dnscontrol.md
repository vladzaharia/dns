# DNSControl

Polaris DNS is built on top of [DNSControl](https://docs.dnscontrol.org/), an infrastructure-as-code tool for DNS management.

## What is DNSControl?

DNSControl is an open-source tool by Stack Exchange that allows you to:

- **Declare DNS records** in code
- **Version control** your DNS configuration
- **Preview changes** before applying
- **Support multiple providers** with a single configuration

## DNSControl DSL

DNSControl uses a JavaScript-based DSL (Domain Specific Language).

### Basic Structure

```javascript
// creds.json - Provider credentials
{
  "cloudflare": {
    "TYPE": "CLOUDFLAREAPI",
    "apitoken": "your-token"
  }
}

// dnsconfig.js - DNS configuration
var REG_NONE = NewRegistrar("none");
var DSP_CLOUDFLARE = NewDnsProvider("cloudflare");

D("example.com", REG_NONE, DnsProvider(DSP_CLOUDFLARE),
  A("@", "192.0.2.1"),
  CNAME("www", "@"),
  MX("@", 10, "mail.example.com."),
);
```

### Core Functions

| Function | Purpose |
|----------|---------|
| `D()` | Define a domain |
| `A()` | Create A record |
| `AAAA()` | Create AAAA record |
| `CNAME()` | Create CNAME record |
| `MX()` | Create MX record |
| `TXT()` | Create TXT record |
| `CAA()` | Create CAA record |
| `SRV()` | Create SRV record |

### Provider Functions

| Function | Purpose |
|----------|---------|
| `NewRegistrar()` | Create registrar instance |
| `NewDnsProvider()` | Create DNS provider instance |
| `DnsProvider()` | Specify DNS provider for domain |

## How Polaris DNS Uses DNSControl

Polaris DNS wraps DNSControl with TypeScript for type safety and better developer experience.

### Compilation Flow

```
TypeScript Source (src/)
        ↓
    Webpack Build
        ↓
JavaScript Bundle (dist/dnsconfig.js)
        ↓
    DNSControl CLI
        ↓
  DNS Provider APIs
```

### Type-Safe Wrappers

```typescript
// Polaris DNS (TypeScript)
createDomain(
  { name: "example.com", category: "personal" },
  createARecord("@", "192.0.2.1"),
  createCNAMERecord("www", "@"),
);

// Compiles to DNSControl (JavaScript)
D("example.com", REG_NONE, DnsProvider(DSP_CLOUDFLARE),
  A("@", "192.0.2.1"),
  CNAME("www", "@"),
);
```

## DNSControl Commands

### Preview Changes

```bash
dnscontrol preview
```

Shows what changes would be made without applying them.

### Apply Changes

```bash
dnscontrol push
```

Applies changes to DNS providers.

### Check Configuration

```bash
dnscontrol check
```

Validates configuration syntax.

### Get Zone Data

```bash
dnscontrol get-zones --format=js cloudflare - example.com
```

Exports current zone data from provider.

## Provider-Specific Features

### Cloudflare

```javascript
// Proxy control
A("@", "192.0.2.1", CF_PROXY_ON),
A("mail", "192.0.2.1", CF_PROXY_OFF),

// Page Rules
CF_REDIRECT("example.com/*", "https://www.example.com/$1"),

// Workers
CF_WORKER_ROUTE("api.example.com/*", "my-worker"),
```

### AWS Route53

```javascript
// Alias records
R53_ALIAS("@", "ELB", "my-elb.us-east-1.elb.amazonaws.com."),

// Health checks
A("@", "192.0.2.1", R53_HEALTH_CHECK("my-check")),
```

## Configuration Files

### creds.json

Contains provider credentials (never commit to git):

```json
{
  "cloudflare": {
    "TYPE": "CLOUDFLAREAPI",
    "apitoken": "your-api-token"
  },
  "none": {
    "TYPE": "NONE"
  }
}
```

### dnsconfig.js

Main configuration file (generated by Polaris DNS):

```javascript
var REG_NONE = NewRegistrar("none");
var DSP_CLOUDFLARE = NewDnsProvider("cloudflare");

D("example.com", REG_NONE, DnsProvider(DSP_CLOUDFLARE),
  DefaultTTL(1),
  A("@", "192.0.2.1"),
  // ... more records
);
```

## Resources

- [DNSControl Documentation](https://docs.dnscontrol.org/)
- [DNSControl GitHub](https://github.com/StackExchange/dnscontrol)
- [Provider Documentation](https://docs.dnscontrol.org/service-providers)

## Next Steps

- [Architecture](./architecture) - Polaris DNS architecture
- [Managing Zones](../guides/zones) - Create DNS zones

